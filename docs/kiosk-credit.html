<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<base href="/Quirk-AI-Project-Overview/">
<title>Quirk AI Sales Kiosk • Credit Application</title>

<!-- Shared chrome (works even if files are missing) -->
<link rel="stylesheet" href="assets/kiosk-shared.css">
<script src="assets/kiosk-shared.js"></script>

<!-- Tailwind for quick utility (optional, safe if cached elsewhere) -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
  :focus-visible{outline:2px solid #34d399;outline-offset:2px}
  body{
    background:
      linear-gradient(rgba(255,255,255,.58),rgba(255,255,255,.58)),
      url("assets/kiosk.png") center/cover fixed no-repeat!important;
    min-height:100vh;
  }
  /* page chrome */
  .chrome{max-width:1100px;margin:0 auto;padding:24px 16px}
  .card{background:rgba(255,255,255,.9);backdrop-filter:blur(6px);
        border:1px solid #e2e8f0;border-radius:16px;box-shadow:0 25px 50px -12px rgba(0,0,0,.25)}
  .chips button{border:1px solid #d1d5db;border-radius:9999px;padding:4px 8px;font-size:12px;
                display:flex;align-items:center;gap:6px;background:#ffffffb3}
  .chips .active{background:#059669;color:#fff;border-color:#059669}
  .chips .dot{display:inline-flex;align-items:center;justify-content:center;
              width:20px;height:20px;border-radius:9999px;font-weight:700}
  /* form layout */
  .stack{display:flex;flex-direction:column;align-items:center;gap:6px;margin-bottom:14px}
  .label{font-weight:600;color:#0f172a;text-align:center}
  .input{width:260px;border:1px solid #cbd5e1;border-radius:12px;padding:10px 12px;background:#fff}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:18px}
  @media (max-width:720px){.row{grid-template-columns:1fr}}
  .hint{font-size:12px;color:#64748b;text-align:center}
  .divider{border-top:1px dashed #cbd5e1;margin:18px 0}
  .btn{background:linear-gradient(90deg,#059669,#047857);color:#fff;border:none;
       padding:12px 18px;border-radius:9999px;font-weight:700;box-shadow:0 8px 20px rgba(16,185,129,.3)}
  .btn-ghost{border:1px solid #cbd5e1;background:#fff;border-radius:10px;padding:10px 14px}
  /* ssn masking look */
  input[type="password"].ssn{letter-spacing:.08em}
</style>
</head>
<body>
  <div class="relative">
    <div aria-hidden class="pointer-events-none absolute inset-0 overflow-hidden">
      <div class="absolute -top-24 -left-24 h-72 w-72 rounded-full bg-emerald-300/30 blur-3xl"></div>
      <div class="absolute -bottom-24 -right-24 h-72 w-72 rounded-full bg-sky-300/20 blur-3xl"></div>
    </div>

    <div class="chrome relative">
      <!-- header -->
      <header class="text-center mb-4">
        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight text-emerald-900">Quirk AI Sales Kiosk</h1>
      </header>

      <!-- progress chips -->
      <nav aria-label="Progress" class="mb-5">
        <ol class="chips grid grid-cols-4 sm:grid-cols-8 gap-2">
          <!-- 1..8 steps; mark <= current (Credit) as active -->
          <script>
            (function(){
              const steps=['Welcome','Discovery','Vehicle Match','Trade-In','Payments','Credit Start','F&I Options','Review & Handoff'];
              const here=5; // 0-index → Credit
              const ol=document.currentScript.parentElement;
              steps.forEach((label,i)=>{
                const li=document.createElement('li');
                li.innerHTML=
                  `<button class="${i<=here?'active':''}">
                     <span class="dot ${i<=here?'bg-white/20':''}">${i+1}</span>
                     <span class="hidden sm:inline font-semibold">${label}</span>
                   </button>`;
                ol.appendChild(li);
              });
            })();
          </script>
        </ol>
      </nav>

      <!-- library card -->
      <div class="card p-4 sm:p-6">
        <div class="mb-2 text-center">
          <h2 class="text-xl sm:text-2xl font-bold text-emerald-800">Credit Application</h2>
        </div>

        <!-- FORM -->
        <div id="app">
          <!-- Applicant -->
          <div class="row">
            <div>
              <label class="stack">
                <span class="label">Applicant — First name</span>
                <input id="a_first" class="input" autocomplete="given-name">
              </label>
            </div>
            <div>
              <label class="stack">
                <span class="label">Applicant — Last name</span>
                <input id="a_last" class="input" autocomplete="family-name">
              </label>
            </div>
          </div>

          <div class="row">
            <label class="stack">
              <span class="label">Date of birth</span>
              <input id="a_dob" class="input" type="date" placeholder="mm/dd/yyyy">
            </label>
            <label class="stack">
              <span class="label">SSN</span>
              <input id="a_ssn" class="input ssn" type="password" inputmode="numeric" maxlength="11" placeholder="123-45-6789">
              <span class="hint">We’ll mask this automatically</span>
            </label>
          </div>

          <div class="row">
            <label class="stack">
              <span class="label">Mobile</span>
              <input id="a_phone" class="input" inputmode="tel" placeholder="(555) 555-1212">
            </label>
            <label class="stack">
              <span class="label">Email</span>
              <input id="a_email" class="input" type="email" autocomplete="email">
            </label>
          </div>

          <div class="row">
            <label class="stack">
              <span class="label">Employer</span>
              <input id="a_employer" class="input">
            </label>
            <label class="stack">
              <span class="label">Job title</span>
              <input id="a_title" class="input">
            </label>
          </div>

          <div class="row">
            <label class="stack">
              <span class="label">ZIP</span>
              <input id="a_zip" class="input" inputmode="numeric" maxlength="10">
            </label>
            <label class="stack">
              <span class="label">Monthly income ($)</span>
              <input id="a_income" class="input" type="number" min="0" step="100">
            </label>
          </div>

          <div class="divider"></div>
          <div class="hint mb-2">Add a co-applicant (optional)</div>

          <!-- Co-Applicant -->
          <div class="row">
            <label class="stack">
              <span class="label">Co-Applicant — First name</span>
              <input id="c_first" class="input" autocomplete="given-name">
            </label>
            <label class="stack">
              <span class="label">Co-Applicant — Last name</span>
              <input id="c_last" class="input" autocomplete="family-name">
            </label>
          </div>

          <div class="row">
            <label class="stack">
              <span class="label">Date of birth</span>
              <input id="c_dob" class="input" type="date" placeholder="mm/dd/yyyy">
            </label>
            <label class="stack">
              <span class="label">SSN</span>
              <input id="c_ssn" class="input ssn" type="password" inputmode="numeric" maxlength="11" placeholder="123-45-6789">
              <span class="hint">We’ll mask this automatically</span>
            </label>
          </div>

          <!-- Actions -->
          <div class="mt-3 flex flex-col items-center gap-3">
            <!-- Consent (required) -->
            <div class="mt-2 text-sm text-slate-700 max-w-xl text-center">
              <label class="inline-flex items-start gap-2 my-1">
                <input id="consent_fcra" type="checkbox" class="mt-1" required>
                <span>
                  I authorize the dealership and its partners to obtain my consumer report for credit evaluation
                  (<a href="legal/fcra.html" target="_blank" class="underline">details</a>).
                </span>
              </label><br>
              <label class="inline-flex items-start gap-2 my-1">
                <input id="consent_privacy" type="checkbox" class="mt-1" required>
                <span>
                  I agree to the <a href="legal/privacy.html" target="_blank" class="underline">privacy policy</a> and
                  electronic communications (<a href="legal/esign.html" target="_blank" class="underline">E-Sign</a>).
                </span>
              </label>
              <div class="hint mt-1">Your SSN is masked on this device and transmitted over an encrypted connection.</div>
            </div>

            <button id="next" class="btn">Let’s make sure it’s you →</button>
            <a class="btn-ghost" href="saleskiosk-welcome.html">← Back to Kiosk</a>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* helpers (use shared if present) */
const K = window.kiosk || {
  save:(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}},
  load:(k,d)=>{try{const v=JSON.parse(localStorage.getItem(k));return(v??d)}catch{return d}},
  track:()=>{}, post:()=>{}
};
const onlyDigits = v => (v||'').replace(/\D+/g,'');
const fmtPhone = d => { const x=d.slice(0,10); if(!x) return ''; if(x.length<4) return `(${x}`; if(x.length<7) return `(${x.slice(0,3)}) ${x.slice(3)}`; return `(${x.slice(0,3)}) ${x.slice(3,6)}-${x.slice(6)}`; };
const maskSSNOnBlur = (el)=>{ const d=onlyDigits(el.value); if(!d){el.value='';return;} const m=(d.length<=4?d:('•••-••-'+d.slice(-4))); el.dataset._raw=d; el.value=m; el.type='password'; };
const allowEditSSN = (el)=>{ el.type='text'; const raw=el.dataset._raw||onlyDigits(el.value); el.value=raw; el.setSelectionRange(el.value.length,el.value.length); };

function needDOBandSSN(first,last,dob,ssn){
  const hasNames = first.value.trim() && last.value.trim();
  if (hasNames){
    dob.required = true; ssn.required = true;
  } else {
    dob.required = false; ssn.required = false;
  }
}

function wire(){
  const ids = ['a_first','a_last','a_dob','a_ssn','a_phone','a_email','a_employer','a_title','a_zip','a_income',
               'c_first','c_last','c_dob','c_ssn'];
  const el = Object.fromEntries(ids.map(id=>[id, document.getElementById(id)]));
  // phone mask
  el.a_phone.addEventListener('input', e=>{
    const caretFromEnd = e.target.value.length - e.target.selectionStart;
    e.target.value = fmtPhone(onlyDigits(e.target.value));
    const pos = Math.max(0, e.target.value.length - caretFromEnd);
    requestAnimationFrame(()=> e.target.setSelectionRange(pos,pos));
  });
  // ssn mask + editable
  [el.a_ssn, el.c_ssn].forEach(inpt=>{
    inpt.addEventListener('blur', ()=>maskSSNOnBlur(inpt));
    inpt.addEventListener('focus', ()=>allowEditSSN(inpt));
  });
  // conditional required when both names present
  ['input','change','blur'].forEach(evt=>{
    el.a_first.addEventListener(evt, ()=>needDOBandSSN(el.a_first,el.a_last,el.a_dob,el.a_ssn));
    el.a_last .addEventListener(evt, ()=>needDOBandSSN(el.a_first,el.a_last,el.a_dob,el.a_ssn));
    el.c_first.addEventListener(evt, ()=>needDOBandSSN(el.c_first,el.c_last,el.c_dob,el.c_ssn));
    el.c_last .addEventListener(evt, ()=>needDOBandSSN(el.c_first,el.c_last,el.c_dob,el.c_ssn));
  });
  // seed from kiosk profile (optional)
  const p = K.load('kiosk_profile',{name:'',contact:''});
  if(p?.contact){ el.a_phone.value = fmtPhone(onlyDigits(p.contact)); }

  // Next -> submit to backend API
  document.getElementById('next').addEventListener('click', ()=>{
    const payload = {
      a:{ first:el.a_first.value,last:el.a_last.value,dob:el.a_dob.value,ssn:el.a_ssn.dataset._raw||onlyDigits(el.a_ssn.value),
          phone:el.a_phone.value,email:el.a_email.value,employer:el.a_employer.value,title:el.a_title.value,zip:el.a_zip.value,
          income:Number(el.a_income.value||0) },
      c:(el.c_first.value || el.c_last.value) ? {
          first:el.c_first.value,last:el.c_last.value,dob:el.c_dob.value,
          ssn:el.c_ssn.dataset._raw||onlyDigits(el.c_ssn.value)
        } : undefined,
      consent:{ fcra: document.getElementById('consent_fcra').checked,
                privacy: document.getElementById('consent_privacy').checked }
    };

    // validate conditional rules quickly
    const mustA = (payload.a.first && payload.a.last) ? (!payload.a.dob || !payload.a.ssn) : false;
    const mustC = (payload.c?.first && payload.c?.last) ? (!payload.c.dob || !payload.c.ssn) : false;
    if(mustA || mustC){ alert('DOB and SSN are required when both first and last name are entered.'); return; }
    if(!payload.consent.fcra || !payload.consent.privacy){ alert('Please provide the required consents to continue.'); return; }

    // save locally for UX continuity
    K.save('guided_credit_basic', payload);
    K.track('credit.start.next');

    // Submit to backend API (default: RouteOne). Absolute path avoids <base> surprises.
    const endpoint = '/api/credit/submit?to=routeone';
    fetch(endpoint, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    })
    .then(async r => {
      const d = await r.json().catch(()=>({}));
      if(!r.ok || !d.ok) throw new Error(d.error || 'Submission failed');
      try{ K.post('credit:done'); }catch{}
      alert(`Submitted to ${d.vendor}. Tracking ID: ${d.id}. Next step: phone verification.`);
    })
    .catch(err => {
      console.error(err);
      alert('Sorry—there was a problem submitting your application.');
    });
  });
}
document.addEventListener('DOMContentLoaded', wire);
</script>
</body>
</html>
