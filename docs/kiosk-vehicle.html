<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<base href="/Quirk-AI-Project-Overview/"><title>Kiosk • Vehicle Match</title>
<link rel="stylesheet" href="assets/kiosk-shared.css">
<script src="assets/kiosk-shared.js"></script>
<style>
  .filters { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:10px; }
  .grid { display:grid; gap:14px; grid-template-columns: 1fr; }
  @media (min-width: 768px) { .grid { grid-template-columns: repeat(3, 1fr); } }

  .card { background:#fff; border:1px solid #e2e8f0; border-radius:16px; padding:10px; box-shadow: 0 2px 14px rgba(0,0,0,.05); text-align:left; }
  .card:hover { box-shadow: 0 6px 22px rgba(0,0,0,.08); transform: translateY(-1px); }

  .thumbWrap { position:relative; }
  .thumb { width:100%; height:160px; border-radius:12px; object-fit:cover; display:block; }
  .ph {
    width:100%; height:160px; border-radius:12px;
    background: linear-gradient(135deg,#e5e7eb,#cbd5e1);
    display:none; align-items:center; justify-content:center;
    color:#334155; text-align:center;
  }
  .ph .make { font-weight:700; }
  .ph .model { font-size:.9rem; opacity:.9; }

  .stock { position:absolute; left:8px; bottom:8px; font-size:.7rem; color:#fff; background:rgba(0,0,0,.55); padding:.2rem .5rem; border-radius:9999px; }
  .price { color:#047857; font-weight:800; font-size:1.05rem; margin-top:6px; }
  .muted { color:#64748b; font-size:.85rem; }

  .pill { display:inline-flex; align-items:center; gap:6px; padding:.25rem .6rem; border-radius:9999px; background:#f1f5f9; color:#334155; font-size:.75rem; font-weight:600; }
</style>
</head><body>
<div class="kx">
  <h2>Vehicle Match</h2>
  <p class="sub">Pick one to continue.</p>

  <div class="filters">
    <span id="criteria" class="pill">Loading buying power…</span>
    <span id="found" class="pill">0 vehicles found</span>
  </div>

  <div id="list" class="grid"></div>

  <p class="note" style="margin-top:10px">
    Reads <code>guided_profile.budget</code> and <code>guided_desk.apr/term</code> from Discovery.
    Inventory loads from <code>inventory.json</code> (root), then <code>assets/inventory.json</code>, then <code>sandbox/inventory.json</code>.
    Thumbnails mirror <em>saleskiosk-welcome.html</em>: photo if present, otherwise a clean placeholder with Make/Model.
  </p>
</div>

<script>
const { save, load, post } = window.kiosk;

/* ---------- finance helpers ---------- */
function amountFromPayment(pmt, aprPct, termMonths){
  const r = aprPct/100/12;
  if (!r) return pmt * termMonths;
  return pmt * (1 - Math.pow(1 + r, -termMonths)) / r;
}
const OVER_FLEX    = 5000;  // allow up to +$5,000 over buying power
const DOWN_DEFAULT = 0;

/* ---------- image sources (match welcome page behavior) ---------- */
const VEHICLE_IMAGES = {
  '2025_Chevrolet_Silverado 1500': 'assets/2025-silverado-1500.jpg',
  '2025_Chevrolet_Equinox':       'assets/2025-equinox.jpg',
  '2025_Chevrolet_Traverse':      'assets/2025-traverse.jpg',
  '2025_Chevrolet_Trax':          'assets/2025-trax.jpg',
  '2025_Chevrolet_Trailblazer':   'assets/2025-trailblazer.jpg',
  '2025_Chevrolet_Malibu':        'assets/2025-malibu.jpg',
  '2025_Chevrolet_Colorado':      'assets/2025-colorado.jpg',
  '2025_Chevrolet_Blazer':        'assets/2025-blazer.jpg',
  '2025_Chevrolet_Tahoe':         'assets/2025-tahoe.jpg',
  '2019_Toyota_Camry':            'assets/camry.jpg',
  '2020_Honda_CR-V':              'assets/CRV.jpg',
  '2021_Ford_F-150':              'assets/F150.webp',
  '2022_Nissan_Altima':           'assets/altima.jpg'
};
function specificImage(year, make, model){
  return VEHICLE_IMAGES[`${year}_${make}_${model}`] || null;
}
const PHOTO_ROOT = 'assets/kiosk-photos/';
const MODEL_PHOTOS = {
  Chevrolet: { 'Silverado 1500':'chevrolet-silverado-1500.jpg','Equinox':'chevrolet-equinox.jpg','Traverse':'chevrolet-traverse.jpg','Trax':'chevrolet-trax.jpg','Trailblazer':'chevrolet-trailblazer.jpg','Malibu':'chevrolet-malibu.jpg','Colorado':'chevrolet-colorado.jpg','Blazer':'chevrolet-blazer.jpg','Tahoe':'chevrolet-tahoe.jpg' },
  GMC: { 'Sierra 1500':'gmc-sierra-1500.jpg','Terrain':'gmc-terrain.jpg','Acadia':'gmc-acadia.jpg','Canyon':'gmc-canyon.jpg','Yukon':'gmc-yukon.jpg' },
  Buick: { 'Encore GX':'buick-encore-gx.jpg','Envision':'buick-envision.jpg','Envista':'buick-envista.jpg' }
};
const MAKE_DEFAULT = { Chevrolet:'chevrolet-default.jpg', GMC:'gmc-default.jpg', Buick:'buick-default.jpg', Used:'used-default.jpg' };
function libraryImage(make, model){
  const file = (MODEL_PHOTOS[make] && MODEL_PHOTOS[make][model]) || MAKE_DEFAULT[make] || 'placeholder.jpg';
  return `${PHOTO_ROOT}${file}`;
}
function pickThumb(v){
  if (v.photo) return v.photo;
  const s = specificImage(v.year, v.make, v.model);
  if (s) return s;
  return libraryImage(v.make, v.model);
}

/* ---------- inventory loader ---------- */
async function loadInventory(){
  try { const r = await fetch('inventory.json', {cache:'no-store'}); if (r.ok) return await r.json(); } catch {}
  try { const r = await fetch('assets/inventory.json', {cache:'no-store'}); if (r.ok) return await r.json(); } catch {}
  try { const r = await fetch('sandbox/inventory.json', {cache:'no-store'}); if (r.ok) return await r.json(); } catch {}
  return [];
}

/* ---------- card renderer (with true image + blank placeholder fallback) ---------- */
function card(row){
  // normalize fields
  const v = {
    vin:   row.vin ?? row.VIN ?? row.vin_number ?? '',
    year:  row.year ?? row.Year ?? '',
    make:  row.make ?? row.Make ?? '',
    model: row.model ?? row.Model ?? '',
    trim:  row.trim ?? row.Trim ?? '',
    color: row.color ?? row.Color ?? '',
    price: Number(row.price ?? row.salePrice ?? row.msrp ?? row.Price ?? 0),
    stockType: row.stockType ?? row.stock_type ?? row.StockType ?? '',
    photo: row.photo ?? row.Photo ?? null
  };

  const el = document.createElement('button');
  el.className = 'card';
  el.innerHTML = `
    <div class="thumbWrap">
      <img class="thumb" loading="lazy" alt="${v.year} ${v.make} ${v.model}">
      <div class="ph">
        <div>
          <div class="make">${v.make || '—'}</div>
          <div class="model">${v.model || ''}</div>
        </div>
      </div>
      <span class="stock">${v.stockType || ''}</span>
    </div>
    <div style="margin-top:8px; font-weight:700">${v.year} ${v.make} ${v.model}</div>
    <div class="price">$${(v.price||0).toLocaleString()}</div>
    <div class="muted">${(v.color || '').trim()}${v.trim ? (v.color?' • ':'') + v.trim : ''}</div>
  `;

  const img = el.querySelector('img.thumb');
  const ph  = el.querySelector('.ph');

  const src = pickThumb(v);
  if (src) {
    img.src = src;
    img.onerror = () => { img.style.display='none'; ph.style.display='flex'; };
  } else {
    img.style.display = 'none';
    ph.style.display  = 'flex';
  }

  el.addEventListener('click', ()=>{
    const desk = load('guided_desk', { price:0, down:2000, apr:6.99, term:72, taxesFees:995, products:{vsc:false,gap:false,maint:false}});
    save('guided_selectedVin', v.vin);
    save('guided_desk', { ...desk, price: v.price || desk.price });
    post('vehicle:done', { vin: v.vin });
  });

  return el;
}

/* ---------- init: compute cap from Discovery, filter, render ---------- */
(async function init(){
  const inv = await loadInventory();

  const profile = load('guided_profile', { budget: 400 });
  const monthlyTarget = Number(profile.budget || 400);

  const desk = load('guided_desk', { apr: 6.99, term: 72, down: DOWN_DEFAULT });
  const apr  = Number(desk.apr || 6.99);
  const term = Number(desk.term || 72);
  const down = Number(desk.down || DOWN_DEFAULT);

  const principal = amountFromPayment(monthlyTarget, apr, term) + down;
  const cap = principal + OVER_FLEX;

  const normalized = inv.map(r => ({
    raw: r,
    price: Number(r.price ?? r.salePrice ?? r.msrp ?? r.Price ?? 0)
  }));
  const keep = normalized
    .filter(x => x.price > 0 && x.price <= cap)
    .sort((a,b)=>a.price-b.price)
    .map(x => x.raw);

  const listEl = document.getElementById('list');
  listEl.innerHTML = '';
  keep.forEach(v => listEl.appendChild(card(v)));

  document.getElementById('criteria').textContent =
    `Target $${monthlyTarget.toFixed(0)}/mo → Buying power $${principal.toLocaleString()} (+$${OVER_FLEX.toLocaleString()} flex → cap $${cap.toLocaleString()})`;
  document.getElementById('found').textContent =
    `${keep.length} vehicle${keep.length===1?'':'s'} found`;
})();
</script>
</body></html>
