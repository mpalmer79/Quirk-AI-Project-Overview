<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Kiosk — Discovery</title>

  <base href="/Quirk-AI-Project-Overview/"/>
  <link rel="stylesheet" href="assets/style.css"/>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :focus-visible { outline: 2px solid #34d399; outline-offset: 2px; }
    body { background: transparent; }

    .field-label { @apply block text-sm font-semibold text-slate-700 mb-1; }
    .field-input { @apply w-full rounded-xl border p-3 bg-white; }

    /* make the two currency fields narrower as in the mock */
    .short-money { width: 17rem; }
    @media (min-width: 640px){ .short-money { width: 20rem; } }
    @media (min-width: 768px){ .short-money { width: 22rem; } }

    /* small payoff box, no spinner */
    .payoff-input { width: 8.5rem; -moz-appearance: textfield; }
    .payoff-input::-webkit-outer-spin-button,
    .payoff-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

    /* center the “Vehicle you’re replacing” section title and style like Discovery */
    .trade-title {
      @apply text-center font-extrabold;
      color: #0b6e37;              /* same green tone */
      font-size: clamp(1.2rem, 2.2vw, 1.4rem);
    }
  </style>
</head>
<body class="p-2">
  <div class="max-w-4xl mx-auto">
    <div class="rounded-2xl border border-slate-200 shadow bg-white/95 p-4 sm:p-6">
      <h2 class="text-center text-xl sm:text-2xl font-bold text-emerald-800">Discovery</h2>
      <p class="text-center text-slate-600 mt-1">Answer a few questions so we can match the right vehicle.</p>

      <!-- FORM -->
      <form id="discForm" class="mt-5 grid gap-5">
        <!-- Row: Vehicle of interest (centered pair when Silverado adds cab) -->
        <div class="grid md:grid-cols-2 gap-4 items-end justify-center">
          <label class="block">
            <span class="field-label">Vehicle you’re interested in</span>
            <select id="model" class="field-input"></select>
          </label>
          <label id="cabWrap" class="block hidden">
            <span class="field-label">Cab style (Silverado)</span>
            <select id="cab" class="field-input">
              <option value="">Any</option>
              <option>Regular Cab</option>
              <option>Double Cab</option>
              <option>Crew Cab</option>
            </select>
          </label>
        </div>

        <!-- Row: Primary use + Tow Capacity -->
        <div class="grid md:grid-cols-2 gap-4">
          <label class="block">
            <span class="field-label">Primary use</span>
            <select id="use" class="field-input">
              <option>Daily commute</option>
              <option>Family / kids</option>
              <option>Work / jobsite</option>
              <option>Hauling / towing</option>
              <option>Adventure / outdoors</option>
              <option>Luxury / performance</option>
            </select>
          </label>
          <label class="block">
            <span class="field-label">Tow Capacity needed</span>
            <select id="towing" class="field-input sm:max-w-md short-money">
              <option>None</option>
              <option>Light (≤ 3,500 lbs)</option>
              <option>Medium (3,500–7,500 lbs)</option>
              <option>Heavy (≥ 7,500 lbs)</option>
            </select>
          </label>
        </div>

        <!-- Row: Seating + Fuel type -->
        <div class="grid md:grid-cols-2 gap-4">
          <label class="block">
            <span class="field-label">Preferred seating</span>
            <select id="seating" class="field-input short-money">
              <option>2</option>
              <option selected>5</option>
              <option>6–7</option>
              <option>8+</option>
            </select>
          </label>
          <label class="block">
            <span class="field-label">Fuel type</span>
            <select id="fuel" class="field-input short-money">
              <option selected>Gasoline</option>
              <option>Diesel</option>
              <option>Hybrid</option>
              <option>Plug-in Hybrid</option>
              <option>Electric</option>
            </select>
          </label>
        </div>

        <!-- Row: Money inputs (narrower) -->
        <div class="grid md:grid-cols-2 gap-4">
          <label class="block">
            <span class="field-label">Initial Investment (approx)</span>
            <div class="relative">
              <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">$</span>
              <input id="priceMin" type="text" inputmode="numeric" class="field-input pl-7 short-money"
                     placeholder="20% recommended downpayment"/>
            </div>
          </label>
          <label class="block">
            <span class="field-label">What is your monthly budget?</span>
            <div class="relative">
              <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">$</span>
              <input id="priceMax" type="text" inputmode="numeric" class="field-input pl-7 short-money"
                     placeholder="$650.00"/>
            </div>
          </label>
        </div>

        <!-- Trade section -->
        <h3 class="trade-title mt-1">Vehicle you’re replacing</h3>

        <div class="grid md:grid-cols-4 gap-4">
          <label class="block">
            <span class="field-label">Year</span>
            <select id="tradeYear" class="field-input">
              <!-- options added in JS -->
            </select>
          </label>

          <label class="block">
            <span class="field-label">Make</span>
            <input id="tradeMake" type="text" class="field-input" placeholder="e.g., Chevrolet"/>
          </label>

          <label class="block">
            <span class="field-label">Model</span>
            <input id="tradeModel" type="text" class="field-input" placeholder="e.g., Equinox"/>
          </label>

          <label class="block">
            <span class="field-label">Estimated payoff</span>
            <div class="relative">
              <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">$</span>
              <input id="payoff" type="text" inputmode="numeric"
                     class="field-input pl-7 payoff-input appearance-none"
                     placeholder="Enter payoff amount here" />
            </div>
          </label>
        </div>

        <!-- Current mileage under Year row -->
        <div class="grid md:grid-cols-4 gap-4">
          <label class="block">
            <span class="field-label">Current mileage</span>
            <input id="mileage" type="text" inputmode="numeric" class="field-input"
                   placeholder="Enter miles"/>
          </label>
        </div>

        <!-- Actions -->
        <div class="flex justify-center pt-1">
          <div class="flex gap-3">
            <button type="button" id="backBtn" class="px-4 py-2 rounded-xl border bg-white/90">← Back</button>
            <button type="submit" class="px-5 py-3 rounded-2xl bg-emerald-600 text-white font-semibold shadow hover:brightness-110">
              Pick a vehicle →
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

<script>
/* ---------- storage helpers ---------- */
const save = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} };
const load = (k, def) => { try { const v = JSON.parse(localStorage.getItem(k)); return (v ?? def); } catch { return def; } };

/* Elements */
const $ = (id) => document.getElementById(id);
const modelEl   = $('model');
const cabWrap   = $('cabWrap');
const cabEl     = $('cab');
const useEl     = $('use');
const towingEl  = $('towing');
const seatingEl = $('seating');
const fuelEl    = $('fuel');
const priceMinEl= $('priceMin');
const priceMaxEl= $('priceMax');
const yearEl    = $('tradeYear');
const tradeMake = $('tradeMake');
const tradeModel= $('tradeModel');
const payoffEl  = $('payoff');
const mileageEl = $('mileage');
const form      = $('discForm');
const backBtn   = $('backBtn');

/* Build model list */
const RAW_MODELS = [
  'Blazer', 'Colorado', 'Corvette E-Ray', 'Corvette Stingray', 'Equinox',
  'Express Cargo 2500', 'Express Cargo 3500', 'Express Cutaway 3500',
  'Low Cab Forward 4500', 'Low Cab Forward 4500 HD', 'Low Cab Forward 5500 HD', 'Low Cab Forward 6500 HD',
  'Silverado 1500', 'Silverado 2500 HD', 'Silverado 3500 HD', 'Silverado 3500 HD Chassis Cab',
  'Silverado 4500 HD', 'Silverado 5500 HD', 'Silverado 6500 HD', 'Silverado EV',
  'Suburban', 'Tahoe', 'Trailblazer', 'Traverse', 'Trax'
];

function customSort(a,b){
  const weight = (name) => name.startsWith('Corvette') ? 0 : (name === 'Trax' ? 2 : 1);
  const wa = weight(a), wb = weight(b);
  if (wa !== wb) return wa - wb;
  return a.localeCompare(b);
}
const MODELS = [...RAW_MODELS].sort(customSort);

function fillModels(){
  modelEl.innerHTML = MODELS.map(m => `<option>${m}</option>`).join('');
}

/* Silverado cab visibility */
function isSilverado(model){
  return /^Silverado\s(1500|2500|3500)/.test(model);
}
function updateCabVisibility(){
  const m = modelEl.value || '';
  cabWrap.classList.toggle('hidden', !isSilverado(m));
}

/* Years dropdown */
function fillYears(){
  const now = new Date().getFullYear();
  const start = 1990;
  let opts = `<option value="" disabled selected>Select Year</option>`;
  for(let y = now; y >= start; y--){
    opts += `<option value="${y}">${y}</option>`;
  }
  yearEl.innerHTML = opts;
}

/* Toggle extra trade fields – vehicle type dropdown removed per spec */

/* Currency helpers */
const numFrom = (s) => Number(String(s).replace(/[^\d.]/g,'') || 0);
const toMoney = (n) => n === 0 ? '' : n.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2});

function attachMoneyMask(el){
  el.addEventListener('blur', () => {
    const val = numFrom(el.value);
    el.value = val ? toMoney(val) : '';
  });
  el.addEventListener('focus', () => {
    el.select();
  });
}

function attachCommaMask(el){
  el.addEventListener('blur', () => {
    const n = numFrom(el.value);
    el.value = n ? n.toLocaleString() : '';
  });
  el.addEventListener('focus', () => el.select());
}

/* Persist */
function persist(){
  const data = {
    model: modelEl.value,
    cab: cabEl.value,
    use: useEl.value,
    towing: towingEl.value,
    seating: seatingEl.value,
    fuel: fuelEl.value,
    priceMin: numFrom(priceMinEl.value) || null,
    priceMax: numFrom(priceMaxEl.value) || null,
    tradeYear: yearEl.value || null,
    tradeMake: tradeMake.value || null,
    tradeModel: tradeModel.value || null,
    payoff: numFrom(payoffEl.value) || null,
    mileage: numFrom(mileageEl.value) || null
  };
  save('guided_needs', data);
  window.parent?.postMessage({ type: 'discovery:update', payload: { model: data.model } }, '*');
}

/* Wire events */
[
  modelEl, cabEl, useEl, towingEl, seatingEl, fuelEl,
  priceMinEl, priceMaxEl, yearEl, tradeMake, tradeModel, payoffEl, mileageEl
].forEach(el => el.addEventListener('input', persist));

modelEl.addEventListener('change', () => { updateCabVisibility(); persist(); });

backBtn.addEventListener('click', () => {
  window.parent?.postMessage({ type: 'discovery:back' }, '*');
});

form.addEventListener('submit', (e) => {
  e.preventDefault();
  persist();
  window.parent?.postMessage({ type: 'discovery:done' }, '*');
});

/* Masks */
attachMoneyMask(priceMinEl);
attachMoneyMask(priceMaxEl);
attachMoneyMask(payoffEl);
attachCommaMask(mileageEl);

/* Seed from storage / parent */
function seedFromStorage(){
  const needs = load('guided_needs', {});
  fillModels();
  fillYears();

  if (needs.model && MODELS.includes(needs.model)) modelEl.value = needs.model;
  updateCabVisibility();
  if (needs.cab) cabEl.value = needs.cab;

  if (needs.use) useEl.value = needs.use;
  if (needs.towing) towingEl.value = needs.towing;
  if (needs.seating) seatingEl.value = needs.seating;
  if (needs.fuel) fuelEl.value = needs.fuel;

  if (needs.priceMin) priceMinEl.value = toMoney(needs.priceMin);
  if (needs.priceMax) priceMaxEl.value = toMoney(needs.priceMax);

  if (needs.tradeYear) yearEl.value = needs.tradeYear;
  if (needs.tradeMake) tradeMake.value = needs.tradeMake;
  if (needs.tradeModel) tradeModel.value = needs.tradeModel;
  if (needs.payoff) payoffEl.value = toMoney(needs.payoff);
  if (needs.mileage) mileageEl.value = Number(needs.mileage).toLocaleString();
}

window.addEventListener('message', (e) => {
  // placeholder for parent-originated seeding if needed later
});

/* Init */
fillModels();
fillYears();
seedFromStorage();
updateCabVisibility();
</script>
</body>
</html>
