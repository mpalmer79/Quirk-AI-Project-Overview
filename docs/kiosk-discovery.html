<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Kiosk — Discovery</title>

  <base href="/Quirk-AI-Project-Overview/"/>
  <link rel="stylesheet" href="assets/style.css"/>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :focus-visible { outline: 2px solid #34d399; outline-offset: 2px; }
    body { background: transparent; }
  </style>
</head>
<body class="p-2">
  <div class="max-w-3xl mx-auto">
    <div class="rounded-2xl border border-slate-200 shadow bg-white/95 p-4 sm:p-6">
      <h2 class="text-center text-xl sm:text-2xl font-bold text-emerald-800">Discovery</h2>
      <p class="text-center text-slate-600 mt-1">Tell us your monthly target.</p>

      <form id="discForm" class="mt-4 grid gap-4">
        <div class="grid sm:grid-cols-3 gap-4">
          <label class="block">
            <span class="block text-sm font-semibold text-slate-700 mb-1">Budget ($/mo)</span>
            <input id="budget" type="number" min="50" step="1" class="w-full rounded-xl border p-3 bg-white" placeholder="400" />
          </label>

          <label class="block">
            <span class="block text-sm font-semibold text-slate-700 mb-1">Term (months)</span>
            <select id="term" class="w-full rounded-xl border p-3 bg-white">
              <option>36</option><option>48</option><option selected>72</option><option>84</option>
            </select>
          </label>

          <label class="block">
            <span class="block text-sm font-semibold text-slate-700 mb-1">APR (%)</span>
            <input id="apr" type="number" step="0.01" min="0" class="w-full rounded-xl border p-3 bg-white" placeholder="6.99"/>
          </label>
        </div>

        <div class="flex justify-between">
          <button type="button" id="backBtn" class="px-4 py-2 rounded-xl border bg-white/90">← Back</button>
          <button type="submit" class="px-5 py-3 rounded-2xl bg-emerald-600 text-white font-semibold shadow hover:brightness-110">
            Pick a vehicle →
          </button>
        </div>
      </form>
    </div>
  </div>

<script>
/* ---------- storage helpers ---------- */
const save = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} };
const load = (k, def) => { try { const v = JSON.parse(localStorage.getItem(k)); return (v ?? def); } catch { return def; } };

const $ = (id) => document.getElementById(id);
const budgetEl = $('budget');
const termEl   = $('term');
const aprEl    = $('apr');
const form     = $('discForm');
const backBtn  = $('backBtn');

/* Seed from parent message or existing storage */
function seedFromStorage() {
  const profile = load('guided_profile', { name:'', contact:'', budget:400 });
  const desk    = load('guided_desk',    { down:2000, apr:6.99, term:72, taxesFees:995, products:{vsc:false,gap:false,maint:false} });

  budgetEl.value = Number(profile.budget || 400);
  termEl.value   = String(desk.term || 72);
  aprEl.value    = Number(desk.apr ?? 6.99);
}

window.addEventListener('message', (e) => {
  const msg = e?.data || {};
  if (msg.type === 'discovery:init') {
    const b = Number(msg.payload?.budget);
    if (!Number.isNaN(b) && b > 0) budgetEl.value = b;
  }
});

/* Persist on change, notify parent in real-time */
function persistAndNotify() {
  const budget = Math.max(0, Number(budgetEl.value || 0));
  const term   = Number(termEl.value || 72);
  const apr    = Number(aprEl.value || 6.99);

  const profile = load('guided_profile', { name:'', contact:'', budget:400 });
  save('guided_profile', { ...profile, budget });

  const desk = load('guided_desk', { down:2000, apr:6.99, term:72, taxesFees:995, products:{} });
  save('guided_desk', { ...desk, apr, term });

  window.parent?.postMessage({ type: 'discovery:update', payload: { budget } }, '*');
}

/* Wire events */
[budgetEl, termEl, aprEl].forEach(el => el.addEventListener('input', persistAndNotify));
backBtn.addEventListener('click', () => {
  window.parent?.postMessage({ type: 'discovery:back' }, '*');
});

/* Submit = proceed */
form.addEventListener('submit', (e) => {
  e.preventDefault();
  persistAndNotify();
  window.parent?.postMessage({ type: 'discovery:done' }, '*');
});

/* initial fill */
seedFromStorage();
</script>
</body>
</html>
