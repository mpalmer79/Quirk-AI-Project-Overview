<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Kiosk — Discovery</title>

  <base href="/Quirk-AI-Project-Overview/"/>
  <link rel="stylesheet" href="assets/style.css"/>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :focus-visible { outline: 2px solid #34d399; outline-offset: 2px; }
    body { background: transparent; }
    /* helper classes used below (Tailwind CDN handles utilities directly) */
  </style>
</head>
<body class="p-2">
  <div class="max-w-4xl mx-auto">
    <!-- removed inner gray border -->
    <div class="rounded-2xl shadow bg-white/95 p-4 sm:p-6">
      <h2 class="text-center text-xl sm:text-2xl font-bold text-emerald-800">Discovery</h2>
      <p class="text-center text-slate-600 mt-1">Answer a few questions so we can match the right vehicle.</p>

      <!-- FORM -->
      <form id="discForm" class="mt-5 grid gap-5">
        <!-- Row: Vehicle of interest (centered) -->
        <div class="grid md:grid-cols-2 gap-4 items-end justify-items-center">
          <label class="block w-full max-w-md mx-auto">
            <span class="block text-sm font-semibold text-slate-700 mb-1">Vehicle you’re interested in</span>
            <select id="model" class="w-full rounded-xl border p-3 bg-white"></select>
          </label>
          <label id="cabWrap" class="block hidden w-full max-w-md">
            <span class="block text-sm font-semibold text-slate-700 mb-1">Cab style (Silverado)</span>
            <select id="cab" class="w-full rounded-xl border p-3 bg-white">
              <option value="">Any</option>
              <option>Regular Cab</option>
              <option>Double Cab</option>
              <option>Crew Cab</option>
            </select>
          </label>
        </div>

        <!-- Row: Primary use + Towing need -->
        <div class="grid md:grid-cols-2 gap-4">
          <label class="block">
            <span class="block text-sm font-semibold text-slate-700 mb-1">Primary use</span>
            <select id="use" class="w-full rounded-xl border p-3 bg-white">
              <option>Daily commute</option>
              <option>Family / kids</option>
              <option>Work / jobsite</option>
              <option>Hauling / towing</option>
              <option>Adventure / outdoors</option>
              <option>Luxury / performance</option>
            </select>
          </label>
          <label class="block">
            <span class="block text-sm font-semibold text-slate-700 mb-1">Towing need</span>
            <select id="towing" class="w-full rounded-xl border p-3 bg-white">
              <option>None</option>
              <option>Light (≤ 3,500 lbs)</option>
              <option>Medium (3,500–7,500 lbs)</option>
              <option>Heavy (≥ 7,500 lbs)</option>
            </select>
          </label>
        </div>

        <!-- Row: Seating + Fuel type -->
        <div class="grid md:grid-cols-2 gap-4">
          <label class="block">
            <span class="block text-sm font-semibold text-slate-700 mb-1">Preferred seating</span>
            <select id="seating" class="w-full rounded-xl border p-3 bg-white">
              <option>2</option>
              <option selected>5</option>
              <option>6–7</option>
              <option>8+</option>
            </select>
          </label>
          <label class="block">
            <span class="block text-sm font-semibold text-slate-700 mb-1">Fuel type</span>
            <select id="fuel" class="w-full rounded-xl border p-3 bg-white">
              <option selected>Gasoline</option>
              <option>Diesel</option>
              <option>Hybrid</option>
              <option>Plug-in Hybrid</option>
              <option>Electric</option>
            </select>
          </label>
        </div>

        <!-- Row: Investment + Budget (currency formatting) -->
        <div class="grid md:grid-cols-2 gap-4">
          <label class="block">
            <span class="block text-sm font-semibold text-slate-700 mb-1">Initial Investment (approx)</span>
            <input
              id="priceMin"
              type="text"
              inputmode="decimal"
              class="w-full rounded-xl border p-3 bg-white"
              placeholder="20% recommended downpayment" />
          </label>

          <label class="block">
            <span class="block text-sm font-semibold text-slate-700 mb-1">What is your monthly budget?</span>
            <input
              id="priceMax"
              type="text"
              inputmode="decimal"
              class="w-full rounded-xl border p-3 bg-white"
              placeholder="$650.00" />
          </label>
        </div>

        <!-- Row: Replacement / Trade info -->
        <div class="grid gap-4">
          <label class="block">
            <span class="block text-sm font-semibold text-slate-700 mb-1">Vehicle you’re replacing</span>
            <select id="replace" class="w-full rounded-xl border p-3 bg-white">
              <option selected>N/A (not replacing)</option>
              <option>Car (sedan/coupe)</option>
              <option>SUV / Crossover</option>
              <option>Truck</option>
              <option>Van</option>
              <option>Other</option>
            </select>
          </label>

          <div id="tradeExtra" class="grid md:grid-cols-4 gap-4 hidden">
            <label class="block">
              <span class="block text-sm font-semibold text-slate-700 mb-1">Year</span>
              <input id="tradeYear" type="number" min="1990" max="2099" class="w-full rounded-xl border p-3 bg-white" placeholder="e.g., 2018"/>
            </label>
            <label class="block">
              <span class="block text-sm font-semibold text-slate-700 mb-1">Make</span>
              <input id="tradeMake" type="text" class="w-full rounded-xl border p-3 bg-white" placeholder="e.g., Chevrolet"/>
            </label>
            <label class="block">
              <span class="block text-sm font-semibold text-slate-700 mb-1">Model</span>
              <input id="tradeModel" type="text" class="w-full rounded-xl border p-3 bg-white" placeholder="e.g., Equinox"/>
            </label>
            <label class="block">
              <span class="block text-sm font-semibold text-slate-700 mb-1">Estimated payoff</span>
              <div class="relative">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">$</span>
                <input id="payoff" type="number" min="0" step="100" class="w-full rounded-xl border p-3 bg-white pl-7" value="0" />
              </div>
            </label>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex justify-between pt-1">
          <button type="button" id="backBtn" class="px-4 py-2 rounded-xl border bg-white/90">← Back</button>
          <button type="submit" class="px-5 py-3 rounded-2xl bg-emerald-600 text-white font-semibold shadow hover:brightness-110">
            Pick a vehicle →
          </button>
        </div>
      </form>
    </div>
  </div>

<script>
// ---------- storage helpers ----------
const save = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} };
const load = (k, def) => { try { const v = JSON.parse(localStorage.getItem(k)); return (v ?? def); } catch { return def; } };

// Elements
const $ = (id) => document.getElementById(id);
const modelEl   = $('model');
const cabWrap   = $('cabWrap');
const cabEl     = $('cab');
const useEl     = $('use');
const towingEl  = $('towing');
const seatingEl = $('seating');
const fuelEl    = $('fuel');
const priceMinEl= $('priceMin');   // Initial Investment
const priceMaxEl= $('priceMax');   // Monthly Budget
const replaceEl = $('replace');
const tradeExtra= $('tradeExtra');
const tradeYear = $('tradeYear');
const tradeMake = $('tradeMake');
const tradeModel= $('tradeModel');
const payoffEl  = $('payoff');
const form      = $('discForm');
const backBtn   = $('backBtn');

// Currency helpers
const fmtUSD = new Intl.NumberFormat('en-US', { style:'currency', currency:'USD', minimumFractionDigits:2 });
function parseCurrency(str){
  const n = Number(String(str || '').replace(/[^0-9.]/g,''));
  return Number.isFinite(n) ? n : 0;
}
function formatInputCurrency(el){
  const n = parseCurrency(el.value);
  el.value = n ? fmtUSD.format(n) : '';
}
function unformatInput(el){
  const n = parseCurrency(el.value);
  el.value = n ? String(n) : '';
}

// Build model list
const RAW_MODELS = [
  'Blazer', 'Colorado', 'Corvette E-Ray', 'Corvette Stingray', 'Equinox',
  'Express Cargo 2500', 'Express Cargo 3500', 'Express Cutaway 3500',
  'Low Cab Forward 4500', 'Low Cab Forward 4500 HD', 'Low Cab Forward 5500 HD', 'Low Cab Forward 6500 HD',
  'Silverado 1500', 'Silverado 2500 HD', 'Silverado 3500 HD', 'Silverado 3500 HD Chassis Cab',
  'Silverado 4500 HD', 'Silverado 5500 HD', 'Silverado 6500 HD', 'Silverado EV',
  'Suburban', 'Tahoe', 'Trailblazer', 'Traverse', 'Trax'
];

function customSort(a,b){
  const weight = (name) => name.startsWith('Corvette') ? 0 : (name === 'Trax' ? 2 : 1);
  const wa = weight(a), wb = weight(b);
  if (wa !== wb) return wa - wb;
  return a.localeCompare(b);
}
const MODELS = [...RAW_MODELS].sort(customSort);

function fillModels(){
  modelEl.innerHTML = MODELS.map(m => `<option>${m}</option>`).join('');
}
function isSilverado(model){
  return /^Silverado\s(1500|2500|3500)/.test(model);
}
function updateCabVisibility(){
  const m = modelEl.value || '';
  cabWrap.classList.toggle('hidden', !isSilverado(m));
}
function toggleTradeFields(){
  const val = replaceEl.value;
  const show = val && !val.startsWith('N/A');
  tradeExtra.classList.toggle('hidden', !show);
}

// Seed from storage / parent
function seedFromStorage(){
  const needs = load('guided_needs', {});
  fillModels();
  if (needs.model && MODELS.includes(needs.model)) modelEl.value = needs.model;
  updateCabVisibility();
  if (needs.cab) cabEl.value = needs.cab;

  if (needs.use) useEl.value = needs.use;
  if (needs.towing) towingEl.value = needs.towing;
  if (needs.seating) seatingEl.value = needs.seating;
  if (needs.fuel) fuelEl.value = needs.fuel;

  if (needs.priceMin != null) priceMinEl.value = fmtUSD.format(Number(needs.priceMin));
  if (needs.priceMax != null) priceMaxEl.value = fmtUSD.format(Number(needs.priceMax));

  if (needs.replace) replaceEl.value = needs.replace;
  toggleTradeFields();
  if (needs.tradeYear)  tradeYear.value  = needs.tradeYear;
  if (needs.tradeMake)  tradeMake.value  = needs.tradeMake;
  if (needs.tradeModel) tradeModel.value = needs.tradeModel;
  if (needs.payoff != null) payoffEl.value = needs.payoff;
}

window.addEventListener('message', (e) => {
  const msg = e?.data || {};
  if (msg.type === 'discovery:init') {
    // kept for compatibility
  }
});

function persist(){
  const data = {
    model: modelEl.value,
    cab: cabEl.value,
    use: useEl.value,
    towing: towingEl.value,
    seating: seatingEl.value,
    fuel: fuelEl.value,
    // store numerics
    priceMin: priceMinEl.value ? parseCurrency(priceMinEl.value) : null,
    priceMax: priceMaxEl.value ? parseCurrency(priceMaxEl.value) : null,
    replace: replaceEl.value,
    tradeYear: tradeYear.value || null,
    tradeMake: tradeMake.value || null,
    tradeModel: tradeModel.value || null,
    payoff: payoffEl.value ? Number(payoffEl.value) : 0
  };
  save('guided_needs', data);
  window.parent?.postMessage({ type: 'discovery:update', payload: { model: data.model } }, '*');
}

// Wire events
[modelEl, cabEl, useEl, towingEl, seatingEl, fuelEl, replaceEl, tradeYear, tradeMake, tradeModel, payoffEl]
  .forEach(el => el.addEventListener('input', persist));

modelEl.addEventListener('change', () => { updateCabVisibility(); persist(); });
replaceEl.addEventListener('change', () => { toggleTradeFields(); persist(); });

// Currency inputs: format on blur, unformat on focus, persist when typing
[priceMinEl, priceMaxEl].forEach(el => {
  el.addEventListener('focus', () => unformatInput(el));
  el.addEventListener('blur',  () => { formatInputCurrency(el); persist(); });
  el.addEventListener('input', persist);
});

backBtn.addEventListener('click', () => {
  window.parent?.postMessage({ type: 'discovery:back' }, '*');
});

form.addEventListener('submit', (e) => {
  e.preventDefault();
  persist();
  window.parent?.postMessage({ type: 'discovery:done' }, '*');
});

// Init
fillModels();
seedFromStorage();
updateCabVisibility();
</script>
</body>
</html>
