<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Quirk AI — Sales Kiosk (Guided Flow)</title>

  <!-- Force light UI -->
  <meta name="color-scheme" content="light"/>
  <meta name="theme-color" content="#ffffff"/>

  <!-- Site base -->
  <base href="/Quirk-AI-Project-Overview/"/>

  <!-- Global site styles (footer etc.) -->
  <link rel="stylesheet" href="assets/style.css"/>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :focus-visible { outline: 2px solid #34d399; outline-offset: 2px; }
    body {
      background:
        linear-gradient(rgba(255,255,255,.88), rgba(255,255,255,.88)),
        url("assets/kiosk.png") center / cover fixed no-repeat !important;
      min-height: 100vh;
    }
    @supports (-webkit-touch-callout:none){
      :root { color-scheme: light; }
      select, input, textarea { -webkit-appearance: none; }
    }
    iframe { display:block; width:100%; border:0; }
  </style>
</head>
<body class="bg-gradient-to-b from-emerald-50 to-slate-50 min-h-screen">
  <div class="relative w-full min-h-screen">
    <!-- decorative glows -->
    <div aria-hidden class="pointer-events-none absolute inset-0 overflow-hidden">
      <div class="absolute -top-24 -left-24 h-72 w-72 rounded-full bg-emerald-300/30 blur-3xl"></div>
      <div class="absolute -bottom-24 -right-24 h-72 w-72 rounded-full bg-sky-300/20 blur-3xl"></div>
    </div>

    <div class="max-w-6xl mx-auto px-4 sm:px-8 py-6 sm:py-10 relative">
      <header class="mb-4 sm:mb-6 text-center">
        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight text-emerald-900">Quirk AI Sales Kiosk</h1>
      </header>

      <!-- Progress chips -->
      <nav aria-label="Progress" class="mb-5 sm:mb-7">
        <ol id="progress" class="grid grid-cols-4 sm:grid-cols-8 gap-2"></ol>
      </nav>

      <!-- Step container -->
      <div class="bg-white/90 backdrop-blur rounded-2xl shadow-2xl border border-slate-200 p-4 sm:p-6">
        <div id="stepHeader" class="mb-4">
          <h2 id="stepTitle" class="text-xl sm:text-2xl font-bold text-emerald-800 text-center"></h2>
          <p id="stepSubtitle" class="text-center text-slate-600 mt-1"></p>
        </div>
        <div class="rounded-xl border bg-white overflow-hidden">
          <iframe id="stage" title="Kiosk Module"></iframe>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <small>© 2025 Quirk AI — Sales Kiosk</small>
  </footer>

<script>
/* ========= tiny storage + analytics (kept minimal) ========= */
function track(event, data = {}) {
  try {
    const now = new Date().toISOString();
    const row = { event, at: now, ...data };
    const key = "guidedflow_analytics";
    const arr = JSON.parse(localStorage.getItem(key) || "[]");
    arr.push(row);
    localStorage.setItem(key, JSON.stringify(arr));
  } catch {}
}
const save = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} };
const load = (k, def) => { try { const v = JSON.parse(localStorage.getItem(k)); return (v ?? def); } catch { return def; } };

/* ========= steps config: ALL steps are external HTMLs ========= */
const STEPS = [
  { label:'Welcome',         url:'kiosk-welcome.html',  height:220, subtitle:"We’ll guide you through a few quick steps." },
  // Increased height so the module never needs its own scrollbar
  { label:'Discovery',       url:'kiosk-discovery.html',height:560, subtitle:"Tell us your monthly target." },
  { label:'Vehicle Match',   url:'kiosk-vehicle.html',  height:720, subtitle:"Pick one to continue." },
  { label:'Trade-In',        url:'kiosk-trade.html',    height:620, subtitle:"Enter your VIN/miles; we’ll pre-value it." },
  { label:'Payments',        url:'kiosk-payments.html', height:720, subtitle:"Taxes/fees estimated; lender approval required." },
  { label:'Credit Start',    url:'kiosk-credit.html',   height:520, subtitle:"Soft pull first. No impact to score until you consent to submit." },
  { label:"F&I Options",     url:'kiosk-fandi.html',    height:420, subtitle:"Add options and see the impact instantly." },
  { label:'Review & Handoff',url:'kiosk-review.html',   height:520, subtitle:"We’ll prep your buyer’s order and hand you off." }
];

const stage = document.getElementById('stage');
const progress = document.getElementById('progress');
const stepTitle = document.getElementById('stepTitle');
const stepSubtitle = document.getElementById('stepSubtitle');

let step = load("guided_step", 0);
let maxVisited = load("guided_maxVisited", step);

/* ========= render progress row ========= */
function renderProgress(){
  progress.innerHTML = '';
  STEPS.forEach((s, i) => {
    const reachable = i <= maxVisited;
    const active = i <= step;
    const li = document.createElement('li');
    li.innerHTML = `
      <button class="w-full flex items-center gap-2 p-1 rounded-full border border-slate-200
                     ${active ? 'bg-emerald-600 text-white' : 'bg-white/70 text-slate-600'}
                     ${!reachable ? 'opacity-60 cursor-not-allowed' : ''}"
              ${!reachable ? 'disabled' : ''}>
        <span class="inline-flex h-5 w-5 items-center justify-center rounded-full text-xs font-bold
                     ${active ? 'bg-white/20' : 'bg-slate-200 text-slate-700'}">${i+1}</span>
        <span class="hidden sm:block text-xs font-semibold truncate pr-1">${s.label}</span>
      </button>`;
    const btn = li.querySelector('button');
    btn.addEventListener('click', () => { if (i <= maxVisited) go(i); });
    progress.appendChild(li);
  });
}

/* ========= SAFER: remove known dev notes from child iframes ========= */
function stripDevNotes(doc){
  try {
    if (!doc) return;
    // 1) Remove the disclosure drawer labelled exactly "Open for more"
    doc.querySelectorAll('details').forEach(d => {
      const sum = d.querySelector('summary');
      const txt = (sum?.textContent || '').trim().toLowerCase();
      if (txt === 'open for more') d.remove();
    });
    // 2) Remove any element that contains the internal hint text
    const killPhrases = ['guided_profile', 'welcome:done', 'posts welcome:done'];
    doc.querySelectorAll('*').forEach(el => {
      const t = (el.textContent || '').toLowerCase();
      if (killPhrases.some(p => t.includes(p))) {
        el.remove();
      }
    });
    // 3) Common class hooks (if present)
    doc.querySelectorAll('.dev-note, .debug, [data-dev], [data-debug]').forEach(n => n.remove());
  } catch {}
}

/* ========= load a step (sets title, iframe) ========= */
function loadStep(i){
  step = Math.max(0, Math.min(i, STEPS.length-1));
  maxVisited = Math.max(maxVisited, step);
  save("guided_step", step);
  save("guided_maxVisited", maxVisited);

  const cfg = STEPS[step];
  stepTitle.textContent = cfg.label;
  stepSubtitle.textContent = cfg.subtitle || '';
  stage.src = cfg.url;
  stage.style.height = (cfg.height || 480) + 'px';

  // Seed common data if present, and strip dev drawer after the child loads
  stage.addEventListener('load', function onload(){
    stage.removeEventListener('load', onload);
    try {
      const doc = stage.contentDocument || stage.contentWindow?.document;
      stripDevNotes(doc);

      const profile = load("guided_profile", { name:'', contact:'', budget:400 });
      if (cfg.url.includes('kiosk-welcome.html')) {
        stage.contentWindow?.postMessage({ type:'welcome:init', payload:{ profile } }, '*');
      }
      if (cfg.url.includes('kiosk-discovery.html')) {
        stage.contentWindow?.postMessage({ type:'discovery:init', payload:{ budget: profile.budget } }, '*');
      }
    } catch {}
  });

  renderProgress();
}
function go(i){ loadStep(i); }

/* ========= message bridge from children ========= */
window.addEventListener('message', (e) => {
  const data = e?.data || {};
  if (!data || typeof data !== 'object') return;
  const { type, payload } = data;

  // Welcome
  if (type === 'welcome:done') {
    const p = load("guided_profile", { name:'', contact:'', budget:400 });
    const merged = { ...p, ...(payload || {}) };
    save("guided_profile", merged);
    track('guided_welcome_next');
    go(1);
    return;
  }

  // Discovery
  if (type === 'discovery:update') {
    const p = load("guided_profile", { name:'', contact:'', budget:400 });
    // Persist budget if provided; ignore other fields here (handled later steps)
    save("guided_profile", { ...p, budget: Number(payload?.budget ?? p.budget) });
    return;
  }
  if (type === 'discovery:done') {
    track('guided_discovery_next');
    go(2);
    return;
  }
  if (type === 'discovery:back') { go(0); return; }

  // Vehicle Match (child should persist selection locally)
  if (type === 'vehicle:done') { go(3); return; }

  // Trade
  if (type === 'trade:update') { return; }
  if (type === 'trade:done') { go(4); return; }

  // Payments
  if (type === 'payments:done') { go(5); return; }

  // Credit
  if (type === 'credit:done') { go(6); return; }

  // F&I
  if (type === 'fandi:done') { go(7); return; }
});

/* ========= init (first tab only resets) ========= */
(function init(){
  if (!sessionStorage.getItem('guided_session_started')) {
    sessionStorage.setItem('guided_session_started', '1');
    [
      "guided_step","guided_consent","guided_profile","guided_selectedVin",
      "guided_desk","guided_trade","guided_maxVisited"
    ].forEach(k => { try { localStorage.removeItem(k); } catch {} });
    step = 0;
    maxVisited = 0;
  }
  loadStep(load("guided_step", 0));
})();
</script>
</body>
</html>
