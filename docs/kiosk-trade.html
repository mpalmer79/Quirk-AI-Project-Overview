<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <base href="/Quirk-AI-Project-Overview/">
  <title>Kiosk • Trade-In</title>
  <link rel="stylesheet" href="assets/kiosk-shared.css">
  <script src="assets/kiosk-shared.js"></script>
  <style>
    /* Make the child page grow with no inner scrollbar */
    html, body { height:auto; overflow:visible !important; }
    .kx { overflow:visible; padding-bottom:24px; }

    /* ====== Layout & centering ====== */
    .kx { max-width: 1100px; margin: 0 auto; }
    .card-title { text-align:center; margin:6px 0 14px; color:#0f766e; font-weight:800; font-size:1.25rem; }

    .fieldset {
      border:1px solid #e5e7eb; border-radius:16px;
      padding:16px; background:#fff; margin:16px auto;
      max-width: 980px;                 /* centered card width */
    }

    .fieldset.narrow { max-width: 820px; } /* for the long-text sections */
    .fieldset.wide   { max-width: 980px; }

    .row { display:grid; gap:12px; }
    .row--2 { grid-template-columns: 1fr; }
    @media (min-width: 860px){
      .row--2 { grid-template-columns: 1fr 1fr; }
    }

    /* 3-up row for Wearable Items (centered) */
    .row--3 { grid-template-columns: 1fr; justify-items:stretch; }
    @media (min-width: 980px){
      .row--3 { grid-template-columns: 1fr 1fr 1fr; }
    }

    /* Compact mileage field: visually ~10ch; JS enforces 8 digits */
    #miles { width: 10ch; }
    .sr-only {
      position:absolute !important; width:1px; height:1px; padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }

    /* Footer CTA aligned to the card and centered on wide screens */
    .cta { display:flex; gap:8px; justify-content:flex-end; }
    @media (min-width: 980px){
      .cta { max-width: 980px; margin: 8px auto 24px; }
    }
  </style>
</head>
<body>
<div class="kx">
  <h2>Trade-In</h2>

  <!-- Vehicle Details -->
  <h3 class="card-title">Vehicle Details</h3>
  <div class="fieldset wide">
    <div class="row row--2">
      <label class="field">
        <span class="label">VIN</span>
        <input id="vin" maxlength="17" placeholder="Enter 17 digit VIN" aria-describedby="vinHint">
        <small id="vinHint" class="sr-only">VIN auto-capitalizes; letters I, O, Q are invalid.</small>
      </label>

      <label class="field">
        <span class="label">Current Mileage</span>
        <input id="miles" type="number" min="0" step="1" inputmode="numeric" placeholder="e.g., 45,000">
      </label>
    </div>

    <div class="row row--2">
      <label class="field">
        <span class="label">Condition</span>
        <select id="cond">
          <option>Average</option>
          <option>Good</option>
          <option>Excellent</option>
          <option>Rough</option>
        </select>
      </label>
      <div class="field" aria-hidden="true"></div>
    </div>

    <div class="row row--2">
      <label class="field">
        <span class="label">Year</span>
        <select id="year"></select>
      </label>

      <label class="field">
        <span class="label">Make</span>
        <input id="make" placeholder="e.g., Chevrolet">
      </label>
    </div>

    <div class="row row--2">
      <label class="field">
        <span class="label">Model</span>
        <input id="model" placeholder="e.g., Equinox">
      </label>

      <label class="field">
        <span class="label">Trim Level (if known)</span>
        <input id="trim" placeholder="e.g., LT, Premier">
      </label>
    </div>

    <div class="row row--2">
      <label class="field">
        <span class="label">Exterior Color</span>
        <input id="extColor" placeholder="">
      </label>

      <label class="field">
        <span class="label">Interior Color</span>
        <input id="intColor" placeholder="">
      </label>
    </div>

    <div class="row row--2">
      <label class="field">
        <span class="label">Number of Keys Included</span>
        <input id="keys" type="number" min="0" max="10" placeholder="">
      </label>

      <label class="field">
        <span class="label">Title Status</span>
        <select id="title">
          <option>Clean / I have Title</option>
          <option>Lien</option>
          <option>Rebuilt</option>
          <option>Salvage</option>
        </select>
      </label>
    </div>

    <div class="row row--2">
      <label class="field">
        <span class="label">Number of Owners (estimate OK)</span>
        <input id="owners" type="number" min="0" max="20" placeholder="">
      </label>

      <label class="field">
        <span class="label">Has the vehicle ever been in an accident?</span>
        <select id="accident">
          <option>No</option>
          <option>Yes</option>
        </select>
      </label>
    </div>

    <label class="field">
      <span class="label">If yes, was it professionally repaired?</span>
      <textarea id="accidentRepair" rows="3" placeholder="Yes / No / Details"></textarea>
    </label>
  </div>

  <!-- Tell us about your Vehicle (centered/narrow) -->
  <h3 class="card-title">Tell us about your Vehicle</h3>
  <div class="fieldset narrow">
    <!-- Row 1: Warnings (left) + Mechanical (right) -->
    <div class="row row--2">
      <label class="field">
        <span class="label">Any warning lights on dashboard?</span>
        <select id="warnings"><option>No</option><option>Yes</option></select>
      </label>

      <label class="field">
        <span class="label">Mechanical issues</span>
        <textarea id="mech" rows="3"></textarea>
      </label>
    </div>

    <!-- Row 2: Cosmetic (left) + Interior (right) -->
    <div class="row row--2">
      <label class="field">
        <span class="label">Cosmetic issues</span>
        <textarea id="cosmetic" rows="3"></textarea>
      </label>

      <label class="field">
        <span class="label">Interior clean and damage-free?</span>
        <textarea id="interior" rows="2"></textarea>
      </label>
    </div>

    <!-- Row 3: Mods (left, centered) + Smells (right) -->
    <div class="row row--2">
      <label class="field">
        <span class="label">Aftermarket parts or modifications?</span>
        <textarea id="mods" rows="2"></textarea>
      </label>

      <label class="field">
        <span class="label">Unusual smells?</span>
        <textarea id="smells" rows="2"></textarea>
      </label>
    </div>

    <!-- Row 4: Routine services (full width) -->
    <label class="field">
      <span class="label">Routine services up to date?</span>
      <textarea id="service" rows="2"></textarea>
    </label>
  </div>

  <!-- Wearable Items Check (3-up, centered) -->
  <h3 class="card-title">Wearable Items Check</h3>
  <div class="fieldset wide">
    <div class="row row--3">
      <label class="field">
        <span class="label">Tire Condition</span>
        <select id="tires">
          <option>New</option>
          <option>Good</option>
          <option>Worn</option>
          <option>Needs Replacement</option>
        </select>
      </label>

      <label class="field">
        <span class="label">Brake Condition</span>
        <select id="brakes">
          <option>New</option>
          <option>Good</option>
          <option>Worn</option>
          <option>Needs Replacement</option>
        </select>
      </label>

      <label class="field">
        <span class="label">Other Wear Items (issues?)</span>
        <textarea id="wear" rows="2"></textarea>
      </label>
    </div>
  </div>

  <div class="cta">
    <button id="next" class="btn">Ownership options →</button>
  </div>
</div>

<script>
/* ---------------- helpers / globals ---------------- */
const { save, load, post, track } = window.kiosk;

const vinEl   = document.getElementById('vin');
const milesEl = document.getElementById('miles');
const condEl  = document.getElementById('cond');

const yearEl  = document.getElementById('year');
const makeEl  = document.getElementById('make');
const modelEl = document.getElementById('model');
const trimEl  = document.getElementById('trim');
const extEl   = document.getElementById('extColor');
const intEl   = document.getElementById('intColor');

const keysEl  = document.getElementById('keys');
const titleEl = document.getElementById('title');
const ownersEl= document.getElementById('owners');
const accidentEl = document.getElementById('accident');
const accidentRepairEl = document.getElementById('accidentRepair');

const warningsEl = document.getElementById('warnings');
const mechEl  = document.getElementById('mech');
const cosmeticEl = document.getElementById('cosmetic');
const interiorEl = document.getElementById('interior');
const modsEl  = document.getElementById('mods');
const smellsEl= document.getElementById('smells');
const serviceEl= document.getElementById('service');

const tiresEl = document.getElementById('tires');
const brakesEl= document.getElementById('brakes');
const wearEl  = document.getElementById('wear');

let lastBodyClass = ""; // from VPIC, used by estimator
let currentRange = {low:0, high:0};

/* limit mileage to 8 digits even though type=number ignores maxlength */
milesEl.addEventListener('input', () => {
  const digits = String(milesEl.value || '').replace(/\D/g,'').slice(0,8);
  milesEl.value = digits;
});

/* VIN cleanup */
function clampVIN(raw){
  return String(raw||"")
    .toUpperCase()
    .replace(/[IOQ]/g,'')      // illegal VIN chars
    .replace(/[^A-Z0-9]/g,'')  // strip symbols/spaces
    .slice(0,17);
}

function sendPayload(){
  const payload = {
    vin: vinEl.value || '',
    miles: milesEl.value || '',
    condition: condEl.value,
    year: yearEl.value || '',
    make: makeEl.value || '',
    model: modelEl.value || '',
    trim: trimEl.value || '',
    exterior: extEl.value || '',
    interior: intEl.value || '',
    keys: keysEl.value || '',
    title: titleEl.value || '',
    owners: ownersEl.value || '',
    accident: accidentEl.value || '',
    accidentRepair: accidentRepairEl.value || '',
    warnings: warningsEl.value || '',
    mech: mechEl.value || '',
    cosmetic: cosmeticEl.value || '',
    interiorNotes: interiorEl.value || '',
    mods: modsEl.value || '',
    smells: smellsEl.value || '',
    service: serviceEl.value || '',
    tires: tiresEl.value || '',
    brakes: brakesEl.value || '',
    wear: wearEl.value || '',
    bodyClass: lastBodyClass || '',
    rangeLow: currentRange.low,
    rangeHigh: currentRange.high
  };
  save('guided_trade', payload);
  post('trade:update', payload);
  return payload;
}

/* ---------------- years list (current year + 1 back to 1990) ---------------- */
(function fillYears(){
  const now = new Date();
  const max = now.getFullYear() + 1;
  const start = 1990;
  const opts = ['<option value="" selected disabled">Select Year</option>'];
  for (let y=max; y>=start; y--) opts.push(`<option>${y}</option>`);
  yearEl.innerHTML = opts.join('');
})();

/* ---------------- wholesale estimator (silent) ---------------- */
const WHOLESALE_ANCHORS = {
  SedanCompact: 22000, SedanMidsize: 28000,
  SUVCompact:   32000, SUVMidsize: 42000, SUVFull: 56000,
  PickupHalf:   55000, PickupHD:   65000,
  SportsCar:    60000, Van:        36000, Other: 30000
};
function segmentFromBody(body=""){
  const b = body.toLowerCase();
  if (b.includes("pickup") && b.includes("light")) return "PickupHalf";
  if (b.includes("pickup") && (b.includes("heavy")||b.includes("3500")||b.includes("hd"))) return "PickupHD";
  if (b.includes("sport utility") || b.includes("suv")) {
    if (b.includes("small")||b.includes("compact")) return "SUVCompact";
    if (b.includes("full")) return "SUVFull";
    return "SUVMidsize";
  }
  if (b.includes("van")) return "Van";
  if (b.includes("coupe")||b.includes("convertible")||b.includes("roadster")||b.includes("sport")) return "SportsCar";
  if (b.includes("sedan")) return (b.includes("mid")||b.includes("large")) ? "SedanMidsize" : "SedanCompact";
  return "Other";
}
const COND_MULTI = { Excellent:1.05, Good:1.00, Average:0.93, Rough:0.85 };
function mileageMultiplier(miles){
  const m = Number(miles||0);
  const delta10k = (m - 100000) / 10000;
  let mult = 1 + (delta10k > 0 ? -0.025*delta10k : 0.02*Math.abs(delta10k));
  return Math.max(0.6, Math.min(1.15, mult));
}
function ageMultiplier(age){
  if (age <= 1) return 0.78;
  const mult = 0.78 * Math.pow(0.83, age-1);
  return Math.max(0.10, mult);
}
function wholesaleEstimate({year, bodyClass, miles, condition}){
  const seg = segmentFromBody(bodyClass);
  const anchor = WHOLESALE_ANCHORS[seg] || WHOLESALE_ANCHORS.Other;
  const curYear = new Date().getFullYear();
  const age = Math.max(0, (curYear - Number(year||curYear)));
  const condMult = COND_MULTI[condition] || COND_MULTI.Average;
  let point = anchor * ageMultiplier(age) * mileageMultiplier(miles) * condMult * 1.00;
  point *= 0.72; // wholesale tilt
  point = Math.min(100000, Math.max(900, point));
  const spread = Math.max(500, point * 0.12);
  return { low: Math.round(point - spread), high: Math.round(point + spread), seg };
}
function recomputeSilent(){
  currentRange = wholesaleEstimate({
    year: yearEl.value,
    bodyClass: lastBodyClass,
    miles: milesEl.value,
    condition: condEl.value
  });
  sendPayload(); // persist silently
}

/* ---------------- VIN decoder (VPIC) ---------------- */
async function decodeVIN(vin){
  const clean = clampVIN(vin);
  vinEl.value = clean;
  if (clean.length !== 17) return;

  try {
    const url = `https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvaluesextended/${encodeURIComponent(clean)}?format=json`;
    const r = await fetch(url);
    const data = await r.json();
    const row = (data.Results && data.Results[0]) || {};

    if (row.ModelYear) yearEl.value = row.ModelYear;
    if (row.Make)      makeEl.value = row.Make;
    if (row.Model)     modelEl.value = row.Model;

    const tr = row.Trim || row.Series || "";
    if (tr) trimEl.value = tr;

    lastBodyClass = row.BodyClass || "";
    recomputeSilent();
  } catch (e){
    console.warn('VPIC decode failed', e);
  }
}

/* ---------------- wire up events ---------------- */
vinEl.addEventListener('input', (e)=>{
  const v = clampVIN(e.target.value);
  if (v !== e.target.value) e.target.value = v;
  if (v.length === 17) decodeVIN(v);
  sendPayload();
});
[
  milesEl, condEl, yearEl, makeEl, modelEl, trimEl, extEl, intEl,
  keysEl, titleEl, ownersEl, accidentEl, accidentRepairEl,
  warningsEl, mechEl, cosmeticEl, interiorEl, modsEl, smellsEl, serviceEl,
  tiresEl, brakesEl, wearEl
].forEach(el=> el.addEventListener('input', recomputeSilent));

// Initial state from any stored payload
(function boot(){
  const prev = load('guided_trade', null);
  if (prev){
    vinEl.value = prev.vin || '';
    milesEl.value = prev.miles || '';
    condEl.value = prev.condition || 'Average';
    yearEl.value = prev.year || '';
    makeEl.value = prev.make || '';
    modelEl.value = prev.model || '';
    trimEl.value = prev.trim || '';
    extEl.value = prev.exterior || '';
    intEl.value = prev.interior || '';
    keysEl.value = prev.keys || '';
    titleEl.value = prev.title || 'Clean / I have Title';
    ownersEl.value = prev.owners || '';
    accidentEl.value = prev.accident || 'No';
    accidentRepairEl.value = prev.accidentRepair || '';
    warningsEl.value = prev.warnings || 'No';
    mechEl.value = prev.mech || '';
    cosmeticEl.value = prev.cosmetic || '';
    interiorEl.value = prev.interiorNotes || '';
    modsEl.value = prev.mods || '';
    smellsEl.value = prev.smells || '';
    serviceEl.value = prev.service || '';
    tiresEl.value = prev.tires || 'New';
    brakesEl.value = prev.brakes || 'New';
    wearEl.value = prev.wear || '';
    lastBodyClass = prev.bodyClass || '';
  }
  if (vinEl.value && vinEl.value.length === 17) decodeVIN(vinEl.value);
  recomputeSilent();
})();

/* ---------- Tell parent our height so it can remove the inner scrollbar ---------- */
(function autoHeight(){
  const TARGET_ORIGIN = window.location.origin;
  function sendHeight(){
    const h = Math.max(document.documentElement.scrollHeight, document.body.scrollHeight);
    window.parent?.postMessage({ type: 'trade:height', payload: { height: h } }, TARGET_ORIGIN);
  }
  window.addEventListener('load', sendHeight);
  if ('ResizeObserver' in window) {
    new ResizeObserver(sendHeight).observe(document.documentElement);
  } else {
    setInterval(sendHeight, 600);
    window.addEventListener('resize', sendHeight);
  }
  document.addEventListener('input', sendHeight, true);
})();

document.getElementById('next').addEventListener('click', ()=>{
  const payload = sendPayload();
  track?.('guided_trade_next');
  post('trade:done', payload);
});
</script>
</body>
</html>
