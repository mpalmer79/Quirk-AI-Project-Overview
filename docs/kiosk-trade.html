<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <base href="/Quirk-AI-Project-Overview/">
  <title>Kiosk • Trade-In</title>
  <link rel="stylesheet" href="assets/kiosk-shared.css">
  <script src="assets/kiosk-shared.js"></script>
  <style>
    .row{display:grid;gap:10px}
    .row--2{grid-template-columns:1fr; }
    .row--3{grid-template-columns:1fr; }
    @media (min-width: 800px){
      .row--2{grid-template-columns:1fr 1fr}
      .row--3{grid-template-columns:1fr 1fr 1fr}
    }
    .field{display:flex;flex-direction:column}
    .label{font-weight:700;color:#0f3c2f;margin-bottom:6px}
    .hint{font-size:.85rem;color:#64748b}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:.35rem .6rem;border-radius:9999px;background:#eef2f7;color:#334155;font-size:.8rem}
    .split{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .muted{color:#6b7280}
    .pillbtn{border:none;background:#0ea5a6;color:#fff;border-radius:9999px;padding:.45rem .8rem;cursor:pointer}
    .pillbtn:disabled{opacity:.6;cursor:not-allowed}
    .sectionTitle{font-weight:900;color:#0f3c2f;margin:18px 0 8px}
    .card{border:1px solid #e5e7eb;border-radius:16px;padding:16px;background:#fff}
    .thin{padding:10px}
    input,select,textarea{border:1px solid #e5e7eb;border-radius:12px;padding:.70rem;background:#fff}
    textarea{min-height:60px}
  </style>
</head>
<body>
<div class="kx">
  <h2>Trade-In</h2>
  <p class="sub">Enter your vehicle details; we’ll pre-value it and keep everything with your deal.</p>

  <!-- Quick Estimator -->
  <div class="card">
    <div class="sectionTitle">Quick Estimator</div>
    <div class="row row--2">
      <label class="field">
        <span class="label">VIN</span>
        <input id="vin" placeholder="Enter 17 digit VIN" minlength="17" maxlength="17"
               pattern="[A-HJ-NPR-Za-hj-npr-z0-9]{17}" aria-describedby="vinHint" autocomplete="off">
        <div id="vinHint" class="hint">VIN auto-capitalizes; letters I, O, Q are invalid.</div>
      </label>

      <label class="field">
        <span class="label">Current Mileage</span>
        <input id="miles" type="number" min="0" step="100" placeholder="e.g., 45,000">
      </label>
    </div>

    <div class="row row--2">
      <label class="field">
        <span class="label">Condition</span>
        <select id="cond">
          <option>Average</option>
          <option>Good</option>
          <option>Excellent</option>
          <option>Rough</option>
        </select>
      </label>

      <div class="field">
        <span class="label">Estimate</span>
        <div class="split">
          <span id="rangeNote" class="chip">Est. range: $3,900 – $9,100</span>
          <button id="decodeBtn" class="pillbtn" type="button">Decode VIN & Prefill</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Vehicle Details -->
  <div class="card" style="margin-top:12px">
    <div class="sectionTitle">Vehicle Details</div>

    <div class="row row--2">
      <label class="field">
        <span class="label">Year</span>
        <select id="year">
          <option value="">Select Year</option>
        </select>
      </label>

      <label class="field">
        <span class="label">Make</span>
        <input id="make" placeholder="e.g., Chevrolet">
      </label>
    </div>

    <div class="row row--2">
      <label class="field">
        <span class="label">Model</span>
        <input id="model" placeholder="e.g., Equinox">
      </label>

      <label class="field">
        <span class="label">Trim Level (if known)</span>
        <input id="trim" placeholder="e.g., LT, Premier">
      </label>
    </div>

    <div class="row row--2">
      <label class="field">
        <span class="label">Exterior Color</span>
        <input id="extColor" placeholder="">
      </label>

      <label class="field">
        <span class="label">Interior Color</span>
        <input id="intColor" placeholder="">
      </label>
    </div>

    <div class="row row--2">
      <label class="field">
        <span class="label">Number of Keys Included</span>
        <input id="keys" type="number" min="0" max="10" placeholder="">
      </label>

      <label class="field">
        <span class="label">Title Status</span>
        <select id="title">
          <option>Clean</option>
          <option>Lien</option>
          <option>Rebuilt</option>
          <option>Salvage</option>
        </select>
      </label>
    </div>

    <div class="row row--2">
      <label class="field">
        <span class="label">Number of Owners (estimate OK)</span>
        <input id="owners" type="number" min="0" max="20">
      </label>

      <label class="field">
        <span class="label">Has the vehicle ever been in an accident?</span>
        <select id="accident"><option>No</option><option>Yes</option></select>
      </label>
    </div>

    <label class="field">
      <span class="label">If yes, was it professionally repaired?</span>
      <textarea id="accidentRepair" placeholder="Yes / No / Details"></textarea>
    </label>

    <!-- Extra decoded specs (read-only chips) -->
    <div id="decodedChips" class="thin" style="display:none;margin-top:6px">
      <span class="chip" id="chipBody"></span>
      <span class="chip" id="chipDrive"></span>
      <span class="chip" id="chipTrans"></span>
      <span class="chip" id="chipEngine"></span>
    </div>
  </div>

  <div class="split" style="margin-top:12px">
    <span class="muted">We’ll keep your trade info with your deal.</span>
    <button id="next" class="btn">Start credit →</button>
  </div>
</div>

<script>
/* ---------- helpers ---------- */
const { save, load, post, track } = window.kiosk;
const $ = id => document.getElementById(id);

const vinEl   = $('vin');
const milesEl = $('miles');
const condEl  = $('cond');
const noteEl  = $('rangeNote');
const decodeBtn = $('decodeBtn');

const yearEl  = $('year');
const makeEl  = $('make');
const modelEl = $('model');
const trimEl  = $('trim');
const extEl   = $('extColor');
const intEl   = $('intColor');
const keysEl  = $('keys');
const titleEl = $('title');
const ownersEl= $('owners');
const accEl   = $('accident');
const accRepEl= $('accidentRepair');

const chipsWrap = $('decodedChips');
const chipBody  = $('chipBody');
const chipDrive = $('chipDrive');
const chipTrans = $('chipTrans');
const chipEng   = $('chipEngine');

function estimate(lowBase=3000, highBase=7000){
  const miles = Number(milesEl.value||0);
  const adj = Math.max(0, (100000 - miles)/100000);
  const low = Math.round(lowBase * (0.7 + adj*0.6));
  const high = Math.round(highBase * (0.7 + adj*0.6));
  return [low, high];
}
function persist(){
  const [low, high] = estimate();
  const payload = {
    vin: vinEl.value||'',
    miles: milesEl.value||'',
    condition: condEl.value,
    year: yearEl.value || '',
    make: makeEl.value || '',
    model: modelEl.value || '',
    trim: trimEl.value || '',
    rangeLow: low, rangeHigh: high
  };
  save('guided_trade', payload);
  post('trade:update', payload);
  noteEl.textContent = `Est. range: $${low.toLocaleString()} – $${high.toLocaleString()}`;
}

/* ---------- Year list: current year + 1 back to 1990 ---------- */
(function fillYears(){
  const thisYear = new Date().getFullYear();
  const top = thisYear + 1;
  const opts = ['<option value="">Select Year</option>'];
  for (let y = top; y >= 1990; y--) opts.push(`<option value="${y}">${y}</option>`);
  yearEl.innerHTML = opts.join('');
})();

/* ---------- VIN decoder (NHTSA VPIC) ---------- */
const VPIC_URL = vin => `https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVinValues/${encodeURIComponent(vin)}?format=json`;

function setIf(v, setter){ if (v && String(v).trim() && v !== 'Not Applicable') setter(String(v).trim()); }
function showChips(spec){
  const chips = [];
  chipBody.textContent  = spec.body   ? `Body: ${spec.body}` : '';
  chipDrive.textContent = spec.drive  ? `Drive: ${spec.drive}` : '';
  chipTrans.textContent = spec.trans  ? `Trans: ${spec.trans}` : '';
  chipEng.textContent   = spec.engine ? `Engine: ${spec.engine}` : '';
  chipsWrap.style.display = (spec.body || spec.drive || spec.trans || spec.engine) ? 'block' : 'none';
}
async function decodeVIN(vin){
  if (!vin || vin.length !== 17) return;
  try{
    decodeBtn.disabled = true;
    decodeBtn.textContent = 'Decoding…';
    const r = await fetch(VPIC_URL(vin), { cache: 'no-store' });
    const j = await r.json();
    const row = (j && j.Results && j.Results[0]) || {};

    // Map to fields
    setIf(row.ModelYear, v=>{
      // ensure option exists
      if (![...yearEl.options].some(o=>o.value===v)){
        const opt = document.createElement('option'); opt.value=v; opt.textContent=v; yearEl.appendChild(opt);
      }
      yearEl.value = v;
    });
    setIf(row.Make,  v=> makeEl.value = v);
    setIf(row.Model, v=> modelEl.value = v);
    // Trim often in "Series" or "Trim"
    setIf(row.Trim,   v=> trimEl.value = v);
    if (!trimEl.value) setIf(row.Series, v=> trimEl.value = v);

    // Extra decoded chips (read-only helpers)
    const body  = row.BodyClass || '';
    const drive = row.DriveType || row.AWD || '';
    const trans = [row.TransmissionStyle, row.TransmissionSpeeds].filter(Boolean).join(' • ');
    const eng   = [
      row.EngineConfiguration, row.EngineCylinders ? `${row.EngineCylinders} cyl` : '',
      row.DisplacementL ? `${row.DisplacementL}L` : (row.DisplacementCC ? `${row.DisplacementCC}cc` : '')
    ].filter(Boolean).join(' • ');
    showChips({ body, drive, trans, engine: eng });

    // Announce success
    noteEl.textContent = 'VIN decoded. Review the fields below.';
  } catch (e){
    noteEl.textContent = 'Could not decode VIN right now.';
    showChips({});
    console.error('VIN decode error:', e);
  } finally{
    decodeBtn.disabled = false;
    decodeBtn.textContent = 'Decode VIN & Prefill';
    persist();
  }
}

/* ---------- events ---------- */
[vinEl, milesEl, condEl, yearEl, makeEl, modelEl, trimEl, extEl, intEl, keysEl, titleEl, ownersEl, accEl, accRepEl]
  .forEach(el => el.addEventListener('input', persist));

// Auto-capitalize VIN and decode on 17 chars
vinEl.addEventListener('input', (e)=>{
  const cur = (vinEl.value || '').toUpperCase().replace(/[^A-HJ-NPR-Z0-9]/g,'');
  if (cur !== vinEl.value) vinEl.value = cur;
  if (cur.length === 17) decodeVIN(cur);
});
decodeBtn.addEventListener('click', ()=> decodeVIN(vinEl.value.trim().toUpperCase()));

document.getElementById('next').addEventListener('click', ()=>{
  persist();
  track('guided_trade_next');
  post('trade:done', load('guided_trade',{}));
});

/* ---------- boot ---------- */
persist();
</script>
</body>
</html>
