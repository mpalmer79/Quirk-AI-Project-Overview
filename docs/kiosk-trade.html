<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quirk AI – Trade-In</title>

  <!-- Force light UI + site base -->
  <meta name="color-scheme" content="light" />
  <meta name="theme-color" content="#ffffff" />
  <base href="/Quirk-AI-Project-Overview/">

  <!-- Quirk global styles -->
  <link rel="stylesheet" href="assets/style.css" />

  <!-- Tailwind + React + Babel (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :focus-visible { outline: 2px solid #34d399; outline-offset: 2px; }
    body {
      background: linear-gradient(rgba(255,255,255,.88), rgba(255,255,255,.88)),
                  url("assets/kiosk.png") center / cover fixed no-repeat !important;
      min-height: 100vh;
    }
    input, select, textarea, button {
      background: #ffffff !important;
      color: #0f172a !important;
      border-color: #e5e7eb !important;
    }
    select option { background:#ffffff; color:#0f172a; }
  </style>
</head>
<body class="bg-gradient-to-b from-emerald-50 to-slate-50 min-h-screen">
  <div id="root"></div>

  <footer class="footer">
    <small>© 2025 Quirk AI — Trade-In</small>
  </footer>

<script type="text/babel">
const { useMemo, useState, useEffect } = React;

/* ================= parent communication (iframe) ================= */
const PARENT_ORIGIN = window.location.origin;
const isEmbedded = () => (window.parent && window.parent !== window);
function sendToParent(type, payload = {}) {
  if (isEmbedded()) {
    window.parent.postMessage({ type, payload }, PARENT_ORIGIN);
  }
}

/* ---------- Data: years, makes, models (simple library) ---------- */
const THIS_YEAR = new Date().getFullYear();
const YEARS = Array.from({length: (THIS_YEAR + 1) - 1985 + 1}, (_,i)=> (THIS_YEAR + 1) - i); // desc

const ALL_MAKES = [
  'Acura','Alfa Romeo','Audi','BMW','Buick','Cadillac','Chevrolet','Chrysler','Dodge','Fiat','Ford','GMC',
  'Genesis','Honda','Hyundai','Infiniti','Jeep','Kia','Lexus','Lincoln','Mazda','Mercedes-Benz','Mini','Mitsubishi',
  'Nissan','Porsche','Ram','Subaru','Tesla','Toyota','Volkswagen','Volvo'
];

function availableMakesForYear(year) {
  const y = Number(year);
  return ALL_MAKES.filter(m => !(m === 'Ram' && y && y < 2009));
}

const MODELS_BY_MAKE = {
  Acura: ['ILX','TLX','RDX','MDX'],
  Audi: ['A3','A4','Q5','Q7'],
  BMW: ['3 Series','5 Series','X3','X5'],
  Buick: ['Encore','Encore GX','Envision','Enclave'],
  Cadillac: ['CT5','XT4','XT5','Escalade'],
  Chevrolet: ['Malibu','Trax','Trailblazer','Equinox','Blazer','Traverse','Colorado','Silverado 1500','Tahoe'],
  Chrysler: ['300','Pacifica','Voyager'],
  Dodge: ['Charger','Challenger','Durango','Grand Caravan'],
  Ford: ['Fusion','Escape','Edge','Explorer','F-150'],
  GMC: ['Terrain','Acadia','Canyon','Sierra 1500','Yukon'],
  Genesis: ['G70','G80','GV70','GV80'],
  Honda: ['Civic','Accord','CR-V','Pilot','Ridgeline'],
  Hyundai: ['Elantra','Sonata','Tucson','Santa Fe','Palisade'],
  Infiniti: ['Q50','QX50','QX60'],
  Jeep: ['Renegade','Compass','Cherokee','Grand Cherokee','Wrangler','Gladiator'],
  Kia: ['Forte','K5','Sportage','Sorento','Telluride'],
  Lexus: ['IS','ES','RX','GX'],
  Lincoln: ['Corsair','Nautilus','Aviator','Navigator'],
  Mazda: ['Mazda3','Mazda6','CX-5','CX-9'],
  'Mercedes-Benz': ['C-Class','E-Class','GLC','GLE'],
  Mini: ['Cooper','Countryman'],
  Mitsubishi: ['Mirage','Outlander','Eclipse Cross'],
  Nissan: ['Sentra','Altima','Rogue','Pathfinder','Frontier'],
  Porsche: ['Macan','Cayenne','Panamera'],
  Ram: ['1500','2500','3500','ProMaster'],
  Subaru: ['Impreza','Legacy','Forester','Outback','Ascent'],
  Tesla: ['Model 3','Model Y','Model S','Model X'],
  Toyota: ['Corolla','Camry','RAV4','Highlander','Tacoma'],
  Volkswagen: ['Jetta','Passat','Tiguan','Atlas'],
  Volvo: ['S60','XC40','XC60','XC90']
};

/* ——— UI helpers ——— */
function Field({ label, children, center=false, widthClass="w-full" }) {
  return (
    <label className={`block mb-3 ${center ? 'text-center' : ''}`}>
      <span className="block text-sm font-semibold text-slate-700 mb-1">{label}</span>
      <div className={`${widthClass} mx-auto`}>{children}</div>
    </label>
  );
}
function PrimaryButton(props){
  const cls = (props.className || "") + " px-5 py-3 rounded-2xl bg-gradient-to-r from-emerald-600 to-emerald-700 text-white font-semibold shadow hover:brightness-110 active:brightness-95";
  return <button {...props} className={cls} />;
}
function SectionTitle({ title, subtitle }) {
  return (
    <div className="mb-4">
      <h2 className="text-xl sm:text-2xl font-bold text-emerald-800 text-center">{title}</h2>
      {subtitle && <p className="text-center text-slate-600 mt-1">{subtitle}</p>}
    </div>
  );
}

/* ——— VIN helpers ——— */
const VIN_RE = /^[A-HJ-NPR-Z0-9]{17}$/i;
const MAKE_NORMALIZE = s => {
  if (!s) return s;
  const map = {
    'RAM':'Ram','MERCEDES-BENZ':'Mercedes-Benz','VOLKSWAGEN':'Volkswagen',
    'ALFA ROMEO':'Alfa Romeo'
  };
  const upper = s.toUpperCase();
  if (map[upper]) return map[upper];
  // Title-case words, preserve hyphens
  return s.split(/([\s-])/).map(part =>
    /^[A-Za-z]+$/.test(part) ? part[0].toUpperCase()+part.slice(1).toLowerCase() : part
  ).join('');
};

async function decodeVin(vin) {
  const url = `https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVinValuesExtended/${encodeURIComponent(vin)}?format=json`;
  const res = await fetch(url);
  const data = await res.json();
  const row = (data && data.Results && data.Results[0]) || {};
  return {
    year: row.ModelYear || '',
    make: row.Make || '',
    model: row.Model || ''
  };
}

/* ——— Trade-In app ——— */
function App() {
  const [trade, setTrade] = useState({
    vin:'', miles:'', condition:'Average',
    year:'', make:'', model:''
  });
  const [vinStatus, setVinStatus] = useState(''); // status text below VIN

  // Dropdown lists
  const makesBase = useMemo(() => availableMakesForYear(trade.year || THIS_YEAR), [trade.year]);
  const makes = useMemo(() => {
    // Ensure decoded make is present even if not in the base list
    return trade.make && !makesBase.includes(trade.make) ? [trade.make, ...makesBase] : makesBase;
  }, [makesBase, trade.make]);

  const modelsBase = useMemo(() => MODELS_BY_MAKE[trade.make] || [], [trade.make]);
  const models = useMemo(() => {
    return trade.model && !modelsBase.includes(trade.model) ? [trade.model, ...modelsBase] : modelsBase;
  }, [modelsBase, trade.model]);

  // Auto-decode when VIN hits 17 chars
  useEffect(() => {
    let timer;
    if (VIN_RE.test(trade.vin)) {
      setVinStatus('Decoding VIN…');
      timer = setTimeout(async () => {
        try {
          const decoded = await decodeVin(trade.vin.trim().toUpperCase());
          const year = decoded.year ? String(decoded.year) : '';
          const make = MAKE_NORMALIZE(decoded.make);
          const model = decoded.model || '';

          const next = { ...trade, year, make, model };
          setTrade(next);
          setVinStatus(year || make || model ? `Decoded: ${year || '—'} ${make || ''} ${model || ''}` : 'VIN decoded, but missing data');
          sendToParent('trade:update', next);
        } catch (e) {
          setVinStatus('VIN decode failed. You can still select year/make/model manually.');
        }
      }, 300); // small debounce
    } else {
      if (trade.vin && trade.vin.length >= 10) {
        setVinStatus('VINs are 17 characters. Keep typing…');
      } else {
        setVinStatus('');
      }
    }
    return () => clearTimeout(timer);
  }, [trade.vin]);

  function startCredit() {
    sendToParent('trade:update', trade);
    sendToParent('trade:done', trade);

    if (!isEmbedded()) {
      const params = new URLSearchParams({
        vin: trade.vin || '',
        miles: trade.miles || '',
        condition: trade.condition || 'Average',
        year: trade.year || '',
        make: trade.make || '',
        model: trade.model || '',
        step: '5'
      });
      window.location.href = `saleskiosk-guidedflow.html?${params.toString()}`;
    }
  }

  return (
    <div className="relative w-full min-h-screen">
      <div className="max-w-4xl mx-auto px-4 sm:px-8 py-6 sm:py-10 relative">
        <div className="bg-white/90 backdrop-blur rounded-2xl shadow-2xl border border-slate-200 p-4 sm:p-6">
          <SectionTitle
            title="Tell us about the vehicle that you're replacing"
            subtitle=""
          />

          {/* Row 1: VIN / Mileage / Condition */}
          <div className="grid md:grid-cols-3 gap-4">
            <Field label="VIN (optional, but helpful)" center widthClass="max-w-sm">
              <input
                className="w-full rounded-xl border p-3 focus:ring-2 focus:ring-emerald-300"
                value={trade.vin}
                onChange={e=>setTrade({...trade, vin:e.target.value})}
                placeholder="Scan or type VIN"
                inputMode="text"
                autoComplete="off"
                maxLength={17}
              />
              {vinStatus && <div className="text-xs text-slate-500 mt-1">{vinStatus}</div>}
            </Field>

            <Field label="Mileage" center widthClass="w-40">
              <input
                className="w-full rounded-xl border p-3 text-center focus:ring-2 focus:ring-emerald-300"
                value={trade.miles}
                onChange={e=>setTrade({...trade, miles:e.target.value})}
                placeholder="e.g., 45,500"
                inputMode="numeric"
                size="15"
              />
            </Field>

            <Field label="Condition" center widthClass="w-48">
              <select
                className="w-full rounded-xl border p-3 text-center focus:ring-2 focus:ring-emerald-300"
                value={trade.condition}
                onChange={e=>setTrade({...trade, condition:e.target.value})}
              >
                {['Great','Average','Rough'].map(x => <option key={x}>{x}</option>)}
              </select>
            </Field>
          </div>

          {/* Row 2: Year / Make / Model */}
          <div className="grid md:grid-cols-3 gap-4 mt-2">
            <Field label="Year" center widthClass="w-40">
              <select
                className="w-full rounded-xl border p-3 text-center focus:ring-2 focus:ring-emerald-300"
                value={trade.year}
                onChange={e=>setTrade({ ...trade, year:e.target.value, make:'', model:'' })}
              >
                <option value="" disabled hidden>Select year</option>
                {YEARS.map(y => <option key={y} value={y}>{y}</option>)}
              </select>
            </Field>

            <Field label="Make" center widthClass="max-w-xs">
              <select
                className="w-full rounded-xl border p-3 text-center focus:ring-2 focus:ring-emerald-300"
                value={trade.make}
                onChange={e=>setTrade({ ...trade, make:e.target.value, model:'' })}
                disabled={!trade.year}
              >
                <option value="" disabled hidden>{trade.year ? 'Select make' : 'Choose year first'}</option>
                {makes.map(m => <option key={m} value={m}>{m}</option>)}
              </select>
            </Field>

            <Field label="Model" center widthClass="max-w-xs">
              <select
                className="w-full rounded-xl border p-3 text-center focus:ring-2 focus:ring-emerald-300"
                value={trade.model}
                onChange={e=>setTrade({ ...trade, model:e.target.value })}
                disabled={!trade.make}
              >
                <option value="" disabled hidden>{trade.make ? 'Select model' : 'Choose make first'}</option>
                {models.map(m => <option key={m} value={m}>{m}</option>)}
              </select>
            </Field>
          </div>

          {/* Footer actions */}
          <div className="mt-4 flex justify-between">
            <button className="px-4 py-2 rounded-xl border bg-white/80" onClick={()=>history.back()}>← Back</button>
            <PrimaryButton onClick={startCredit}>Start credit →</PrimaryButton>
          </div>
        </div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
